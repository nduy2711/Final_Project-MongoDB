 <script>
    let originalFileName = ''; // Biến để lưu tên file ảnh ban đầu

    function previewImage(event) {
        const input = event.target;
        if (input.files && input.files[0]) {
            originalFileName = input.files[0].name; // Lưu tên file ảnh ban đầu
            const reader = new FileReader();
            reader.onload = function(e) {
                const imagePreview = document.getElementById('imagePreview');
                imagePreview.src = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
            const fileName = input.files[0].name;
            const fileNameContainer = document.getElementById('fileName');
            fileNameContainer.textContent = fileName;
        }
    }

    document.getElementById('image').addEventListener('change', previewImage);

    // Lấy danh sách ID tù nhân từ server
    fetch('/getPrisonerIds')
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Failed to fetch prisoner IDs');
        })
        .then(prisonerIds => {
            // Lấy ID cuối cùng trong danh sách và tăng lên 1 đơn vị
            const lastPrisonerId = prisonerIds[prisonerIds.length - 1]; // Lấy ID cuối cùng
            const newId = incrementId(lastPrisonerId); // Tính toán id mới
            // Đặt giá trị của input ẩn id
            document.getElementById('id').value = newId;
        })
        .catch(error => {
            console.error('Error fetching prisoner IDs:', error);
        });

    // Hàm để tăng ID lên 1 đơn vị
    function incrementId(id) {
        const numericPart = parseInt(id.substring(8)) + 1; // Lấy phần số sau tiền tố 'PRISONER' và tăng lên 1
        return 'PRISONER' + String(numericPart).padStart(5, '0'); // Tạo ID mới
    }

    function displayMessage(message, isSuccess) {
        const messageContainer = document.getElementById('messageContainer');
        messageContainer.textContent = message;
        if (isSuccess) {
            messageContainer.style.color = '#4caf50'; // Màu xanh cho thông báo thành công
            // Tăng ID lên 1 nếu thêm thành công
            const currentId = document.getElementById('id').value;
            const nextId = incrementId(currentId);
            document.getElementById('id').value = nextId;
        } else {
            messageContainer.style.color = '#f44336'; // Màu đỏ cho thông báo lỗi
        }
    }

    let prisonersArray = []; // Mảng để lưu trữ thông tin tù nhân
    let countAddedPrisoners = 0; // Biến đếm số lượng tù nhân được thêm

    // Hàm thêm tù nhân
function addPrisoner() {
        // Hàm thêm tù nhân
        const prisonerId = document.getElementById('id').value;
        const prisonerName = document.getElementById('name').value;
        const prisonerGender = document.getElementById('gender').value;
        const prisonerDateOfBirth = document.getElementById('date_of_birth').value;
        const prisonerCriminalRecord = document.getElementById('criminal_record').value;
        const prisonerBehavior = document.getElementById('behavior').value;
        const prisonerHealthConditional = document.getElementById('health_conditional').value;
        const imageInput = document.getElementById('image');
        let prisonerImage = null;
        if (imageInput.files && imageInput.files[0]) {
            prisonerImage = imageInput.files[0].name; // Lưu tên file ảnh vào biến prisonerImage
        }

        // Kiểm tra xem các trường thông tin tù nhân có được điền đầy đủ không
        if (prisonerId && prisonerName && prisonerGender && prisonerDateOfBirth && prisonerCriminalRecord && prisonerBehavior && prisonerHealthConditional && prisonerImage) {
            // Tạo đối tượng tù nhân
            const prisoner = {
                id: prisonerId,
                name: prisonerName,
                gender: prisonerGender,
                date_of_birth: prisonerDateOfBirth,
                criminal_record: prisonerCriminalRecord,
                behavior: prisonerBehavior,
                health_conditional: prisonerHealthConditional,
                image: prisonerImage 
            };

            // Thêm tù nhân vào mảng
            prisonersArray.push(prisoner);

            // Hiển thị thông báo thành công
            console.log('Prisoner added:', prisoner);
            countAddedPrisoners++;
            displayMessage(`Prisoner with ID ${prisoner.id} added successfully!`, true);
        } else {
            // Hiển thị thông báo lỗi khi không điền đầy đủ thông tin
            displayMessage('Please fill in all fields before adding prisoner.', false);
        }
    }

    function resetForm(){
        // Xóa giá trị trong các trường thông tin sau khi thêm thành công
            document.getElementById('name').value = '';
            document.getElementById('gender').value = 'Male';
            document.getElementById('date_of_birth').value = '';
            document.getElementById('criminal_record').value = '';
            document.getElementById('behavior').value = '';
            document.getElementById('health_conditional').value = '';
            document.getElementById('fileName').textContent = ''; // Đặt nội dung của span file name về rỗng
document.getElementById('imagePreview').src = ''; // Đặt đường dẫn của ảnh preview về rỗng
            setFocusName();
            prisonersArray = [];
    }

    function setFocusName(){
        document.getElementById('name').focus();
    }

    function submitPrisoners() {
    // Gửi mảng tù nhân lên MongoDB
        fetch('/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(prisonersArray)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok.');
        })
        .then(data => {
            console.log('Response from server:', data);
            // Hiển thị thông báo thành công đi kèm với số lượng tù nhân đã được thêm
            alert(`Added ${countAddedPrisoners} prisoners successfully.`);
            resetForm();
            countAddedPrisoners = 0;
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });
    }

    
    </script>